/*!
 * Piecemeal
 * 
 * 
 * @author Punnett Square
 * @version 0.0.0
 * Copyright . ISC licensed.
 */
angular.module("Piecemeal",["ui.router"]).constant("_",window._).run(function(a){a._=window._}),function(){"use strict";function a(a,b,c){var d={};c.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|venmo):/);var e=function(a,b){return d[window.localStorage.user_id]?void 0:(d[window.localStorage.user_id]=!0,a({method:"POST",url:"/"+window.localStorage.code,data:{user_id:parseInt(window.localStorage.user_id)}}))};console.log("window.localStorage =",window.localStorage),b.otherwise(function(a){var b=a.get("$state");window.localStorage.getItem("code")&&"undefined"!==window.localStorage.getItem("code")?b.go("event.allDishes"):b.go("home")}),a.state("home",{url:"/home",views:{"@":{templateUrl:"app/home/home.html",controller:"HomeCtrl",controllerAs:"home"}}}).state("oAuth",{url:"/oAuth",views:{navbar:{templateUrl:"components/navbar/navbar.html"},"@":{templateUrl:"app/oAuth/oAuth.html",controller:"OAuthCtrl",controllerAs:"oAuth"}}}).state("dashboard",{url:"/dashboard",views:{"@":{templateUrl:"app/dashboard/dashboard.html",controller:"DashboardCtrl",controllerAs:"dashboard"}}}).state("event",{url:"/:id",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"}}}).state("event.allDishes",{url:"/allDishes",views:{"@":{templateUrl:"app/allDishes/allDishes.html",controller:"AllDishesCtrl",controllerAs:"allDishes"}},resolve:{getEventInfo:["$http",e]}}).state("event.guestBill",{url:"/guestBill",views:{"@":{templateUrl:"app/guestBill/guestBill.html",controller:"GuestBillCtrl",controllerAs:"guestBill"}},resolve:{getEventInfo:["$http",e]}}).state("event.hostBill",{url:"/hostBill",views:{"@":{templateUrl:"app/hostBill/hostBill.html",controller:"HostBillCtrl",controllerAs:"hostBill"}},resolve:{getEventInfo:["$http",e]}}).state("event.loading",{url:"/loading",views:{"@":{templateUrl:"app/loading/loading.html",controller:"LoadingCtrl",controllerAs:"loading"}},resolve:{usersList:["$http",function(a){return a({method:"POST",url:"/eventInfo",data:{code:window.location.hash.split("/")[1]}})}]}})}angular.module("Piecemeal").config(a),a.$inject=["$stateProvider","$urlRouterProvider","$compileProvider"]}(),function(){"use strict";function a(a,b){function c(){var a=b.location.origin+"/"+b.localStorage.code;b.socket=io(a)}function d(c,d){b.socket.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b.socket,c)})})}function e(c,d,e){b.socket.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b.socket,c)})})}var f={on:d,emit:e,init:c};return f}angular.module("Piecemeal").factory("socketFactory",a),a.$inject=["$rootScope","$window"]}(),function(){"use strict";function a(a,b,c,d){function e(){c.localStorage.code&&c.location.hash.split("/")[1]===c.localStorage.code||d.path("/home")}function f(a){return"code"===a?c.localStorage.code:"event_id"===a?parseInt(c.localStorage.event_id):"isHost"===a?"false"===c.localStorage.isHost?!1:!0:"user_id"===a?parseInt(c.localStorage.user_id):"username"===a?c.localStorage.username:"billSent"===a?"true"===c.localStorage.billSent?!0:!1:void 0}function g(a){for(var b in c.localStorage)a[b]=f(b)}function h(a){return a.cost/a.users.length}function i(){d.path("/"+u.getSessStorage("code")+"/addDish")}function j(){d.path("/"+u.getSessStorage("code")+"/allDishes")}function k(){d.path("/"+u.getSessStorage("code")+"/guestBill")}function l(){d.path("/"+u.getSessStorage("code")+"/hostBill")}function m(){d.path("/home")}function n(a){for(var b=0;b<u.data.users.length;b++)u.data.users[b].id===a.user_id&&u.data.users[b].dishes.push(a);u.data.dishes.push(a)}function o(a,b){var c;u.data.dishes.forEach(function(d){d.dish_id===a&&(d.users.push(b),c=d)}),u.data.users.forEach(function(a){a.id===b&&a.dishes.push(c)})}function p(a,b){u.data.dishes.forEach(function(c,d){c.dish_id===a&&(c.users.splice(c.users.indexOf(b),1),0===c.users.length&&u.data.dishes.splice(d,1))}),u.data.users.forEach(function(c){if(c.id===b){var d=c.dishes.reduce(function(b,c,d){return b||0===b?b:c.dish_id===a?d:void 0},!1);c.dishes.splice(d,1)}})}function q(){for(var a in c.localStorage)"username"!==a&&"venmoUsername"!==a&&"user_id"!==a&&delete c.localStorage[a];m(),setTimeout(function(){c.location.reload()},1)}function r(a){if(a=_.map(a,_.capitalize),1===a.length)return a[0];if(2===a.length)return a.join(" and ");var b=a.pop();return a.join(", ")+" and "+b}function s(a,b){return r(_(a.users).map(function(a){return b[_.findIndex(b,{id:a})].username}).value())}function t(){a.on("joined",function(a){console.log("Heard 'joined' in appFactory.data:",a),u.data=a,b.$broadcast("joined")}),a.on("newParticipant",function(a){console.log("Heard 'newParticipant' in appFactory:",a),u.data.users.push(a)}),a.on("dishAdded",function(a){console.log("Heard 'dishAdded' in appFactory.data:",a),n(a)}),a.on("dishShared",function(a){console.log("Heard 'dishShared' in appFactory.data:",a),o(a.dish_id,a.user_id)}),a.on("dishUnshared",function(a){console.log("Heard 'dishUnshared' in appFactory.data:",a),p(a.dish_id,a.user_id)}),a.on("billsSentToGuests",function(a){console.log("Heard 'billsSentToGuests' in appFactory.data:",a),u.data.billData=a,b.$broadcast("billsSentToGuests")})}var u={initListeners:t,addDish:n,shareDish:o,unshareDish:p,getSessStorage:f,arrayToSentence:r,getUsersByDish:s,getDishIndivCost:h,goToAllDishes:j,goToGuestBill:k,goToAddDish:i,goToHostBill:l,goToHome:m,copySessData:g,logout:q,checkCode:e};return u}angular.module("Piecemeal").factory("appFactory",a),a.$inject=["socketFactory","$rootScope","$window","$location"]}(),function(){"use strict";function a(a,b,c,d,e,f){var g=this;b.copySessData(g),g.checkCode=b.checkCode;var h=e.location.hash;""===h&&e.localStorage.code&&f.path("/"+e.localStorage.code+"/allDishes"),c.$on("joined",function(){g.data=b.data,console.log("Joined the All Dishes room."),g.calcUserCurrentTotal(g.data)}),g.data=b.data,b.data||(a.init(),b.initListeners()),g.getUsersByDish=b.getUsersByDish,g.isOnDish=function(a,b){return a.reduce(function(a,c){return c.toString()===b.toString()?!0:a},!1)},g.shareDish=function(c,d,e){g.isOnDish(e,d)||(a.emit("shareDish",{dish_id:c,user_id:d}),b.shareDish(c,d))},g.unshareDish=function(c,d,e){g.isOnDish(e,d)&&(a.emit("unshareDish",{dish_id:c,user_id:d}),b.unshareDish(c,d))},$(".modal-trigger").leanModal({opacity:.7,in_duration:230,out_duration:230,calcUserCurrentTotal:g.calcUserCurrentTotal}),g.calcUserCurrentTotal=function(a){return a?d.calculateRunningTotal(a):0},g.addDish=function(b,c){var d={cost:Number(c),name:b,user_id:g.user_id,event_id:g.event_id,users:[g.user_id]};a.emit("addDish",d),g.amount="",g.dishName="",g.addedDish=!0,g.previousDish=b}}angular.module("Piecemeal").controller("AllDishesCtrl",a),a.$inject=["socketFactory","appFactory","$scope","allDishesFactory","$window","$location"]}(),function(){"use strict";function a(a){function b(b){return b?_.filter(b.dishes,function(b,c){return _.contains(b.users,a.getSessStorage("user_id"))}).reduce(function(a,b){return a+Number(b.cost)/b.users.length},0):0}var c={calculateRunningTotal:b};return c}angular.module("Piecemeal").factory("allDishesFactory",a),a.$inject=["appFactory"]}(),function(){"use strict";function a(a,b,c,d){var e=this;e.getUsers=function(a){return d.arrayToSentence(a.map(function(a){return a.username}))},e.getDishNames=function(a){return d.arrayToSentence(a.dishes.map(function(a){return a.name}))},a.createEvent().then(function(a){a=a.data,_.assign(b.localStorage,{username:a.username,code:a.code,isHost:!0,user_id:a.user_id,event_id:a.event_id,venmoUsername:a.venmoUsername}),c.path("/"+a.code+"/allDishes")})["catch"](function(a){console.log("Error in creating event.")})}angular.module("Piecemeal").controller("DashboardCtrl",a),a.$inject=["dashboardFactory","$window","$location","appFactory"]}(),function(){"use strict";function a(a){function b(){return a({method:"GET",url:"/auth/createEvent"})}function c(){return a({method:"GET",url:"/auth/getBills"})}var d={getBills:c,createEvent:b};return d}angular.module("Piecemeal").factory("dashboardFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c,d,e){var f=this;b.copySessData(f),b.checkCode(),a.$on("joined",function(){f.data=b.data,f.getDishIndivCost=b.getDishIndivCost,f.venmoUsername=b.data.venmoUsername}),f.data=b.data,b.data?(f.getDishIndivCost=b.getDishIndivCost,f.venmoUsername=b.data.venmoUsername):(d.init(),b.initListeners()),a.$on("billsSentToGuests",function(){f.data.billData=b.data.billData}),f.getGuestDishes=function(a,b){return f.data?_.filter(b,function(b,c){return _.contains(b.users,a)}):[]},f.getGuestTotal=function(a){return c.calculateRunningTotal(a)},f.getGrandTotal=function(a,b){return f.data?_.sum(_.pluck(a,"cost"))+f.getGuestTip()+f.getGuestTax():0},f.getOtherUsersByUsername=function(a,c,d){return b.arrayToSentence(_(a.users).filter(function(a){return a!==d}).map(function(a){return c[_.findIndex(c,{id:a})].username}).value())},f.getGuestTax=function(){return f.data?f.data.billData.taxPercent*f.getGuestSubtotal(f.data)*.01:0},f.getGuestTip=function(){return f.data?f.data.billData.tipPercent*f.getGuestSubtotal(f.data)*.01:0},f.getGuestFee=function(){return f.data?f.data.billData.feePercent*f.getGuestSubtotal(f.data)*.01:0},f.getGuestDiscount=function(){return f.data?f.data.billData.discountPercent*f.getGuestSubtotal(f.data)*.01:0},f.getGuestSubtotal=function(a){return c.calculateRunningTotal(a)},f.getGuestGrandTotal=function(){return f.data?Math.round(100*(f.getGuestTotal(f.data)+f.getGuestTax()+f.getGuestTip()+f.getGuestFee()-f.getGuestDiscount()))/100:0},f.getAllSubtotal=function(a){return f.data?_.sum(_.pluck(a,"cost")):0},f.cashAlert=function(){Materialize.toast("We have notified the host that you will be<br>paying with cash.",4e3)},f.venmoAlert=function(){e(function(){Materialize.toast("Venmo app required.",4e3)},1e3)}}angular.module("Piecemeal").controller("GuestBillCtrl",a),a.$inject=["$scope","appFactory","allDishesFactory","socketFactory","$timeout"]}(),function(){"use strict";function a(a,b,c){var d=this;d.isVenmo=a.localStorage.venmoUsername,d.incorrectCode=!1;try{a.localStorage.checkPrivateMode="not private"}catch(e){d.privateMode=!0}d.privateMode?Materialize.toast("Turn off Safari Private mode to continue"):a.localStorage.checkPrivateMode=void 0,d.setSessionUser=function(d){d=d.toLowerCase(),b.checkCode(d.toLowerCase()).then(function(e){e.data.isValid?(_.assign(a.localStorage,{code:d,isHost:!1}),a.localStorage.venmoUsername?(a.localStorage.event_id=e.data.id,b.addVenmoUser({user_id:a.localStorage.user_id,event_id:a.localStorage.event_id}).then(function(){c.path("/"+d+"/allDishes")})):c.path("/"+a.localStorage.code+"/loading")):Materialize.toast("Your entered room does not exist. <br>Please try again.",4e3)})["catch"](function(a){console.error(a)})},d.oAuth=function(){if(a.localStorage.venmoUsername){var d={id:a.localStorage.user_id,username:a.localStorage.username};b.createEvent(d).then(function(b){b=b.data,_.assign(a.localStorage,{code:b.code,isHost:!0,event_id:b.event_id}),c.path("/"+b.code+"/allDishes")})["catch"](function(a){console.log("Error in creating event.")})}else c.path("/oAuth")},d.logoutVenmo=function(){a.localStorage.clear(),d.isVenmo=!1,a.location.reload()}}angular.module("Piecemeal").controller("HomeCtrl",a),a.$inject=["$window","homeFactory","$location"]}(),function(){"use strict";function a(a){function b(b){return a({method:"GET",url:"/checkCode/"+b})}function c(b){return a({method:"POST",url:"/auth/createEvent",data:b})}function d(b){return a({method:"PUT",url:"/addVenmoUser",data:b})}var e={checkCode:b,createEvent:c,addVenmoUser:d};return e}angular.module("Piecemeal").factory("homeFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){var d=this;a.copySessData(d),a.checkCode(),c.$on("joined",function(){d.data=a.data,d.getDishIndivCost=a.getDishIndivCost}),d.data=a.data,a.data?d.billsSent=!0:(b.init(),a.initListeners()),d.getDishIndivCost=a.getDishIndivCost,d.getUsersByDish=a.getUsersByDish,d.tipType={value:"percent"},d.taxType={value:"percent"},d.repopulateTip=function(a){return a?a.tipPercent:0},d.repopulateTax=function(a){return a?a.taxPercent:0},d.repopulateFee=function(a){return a?a.feePercent:0},d.repopulateDiscount=function(a){return a?a.discountPercent:0},d.getTip=function(a){if(!d.data)return 0;if("dollar"===d.tipType.value){if("dollar"===a)return d.tip;if("percent"===a){var b=d.tip/d.getSubTotal(d.data.dishes)*100;return Math.round(100*b)/100}}else if("percent"===d.tipType.value){if("dollar"===a)return.01*d.tip*d.getSubTotal(d.data.dishes);if("percent"===a)return d.tip}},d.getTax=function(a){if(!d.data)return 0;if("dollar"===d.taxType.value){if("dollar"===a)return d.tax;if("percent"===a){var b=d.tax/d.getSubTotal(d.data.dishes)*100;return Math.round(100*b)/100}}else if("percent"===d.taxType.value){if("dollar"===a)return.01*d.tax*d.getSubTotal(d.data.dishes);if("percent"===a)return d.tax}},d.getFeeOrDiscountPercent=function(a){if(!d.data)return 0;var b=d.getSubTotal(d.data.dishes);if("fee"===a)var c=d.fee/b*100;else if("discount"===a)var c=d.discount/b*100;return Math.round(100*c)/100},d.getSubTotal=function(a){return _.sum(_.pluck(a,"cost"))},d.getGrandTotal=function(){return d.getSubTotal(d.data.dishes)+d.getTip("dollar")+d.getTax("dollar")+d.fee-d.discount},d.sendBillsToGuests=function(){b.emit("sendBillToGuests",{event_id:d.event_id,code:d.code,hostUsername:d.username,host_id:d.user_id,subTotal:d.getSubTotal(d.data.dishes),taxPercent:d.getTax("percent"),tipPercent:d.getTip("percent"),feePercent:d.getFeeOrDiscountPercent("fee"),discountPercent:d.getFeeOrDiscountPercent("discount"),grandTotal:d.getGrandTotal(),billSent:!0}),d.billsSent=!0},d.sendBillAndAlert=function(){d.sendBillsToGuests(),Materialize.toast("Bills sent successfully!",4e3)},d.logout=a.logout}angular.module("Piecemeal").controller("HostBillCtrl",a),a.$inject=["appFactory","socketFactory","$scope"]}(),function(){"use strict";function a(a,b,c,d,e,f){var g=this;g.currentUsers=_.uniq(_.pluck(e.data,"username")),g.code=b.location.hash.split("/")[1];try{b.localStorage.checkPrivateMode="not private"}catch(h){g.privateMode=!0}g.privateMode?Materialize.toast("Turn off Safari Private mode to continue"):b.localStorage.checkPrivateMode=void 0,g.setSessionUser=function(e){c.sendSessionUser({isHost:!1,username:e,code:b.location.hash.split("/")[1]}).then(function(c){_.assign(b.localStorage,{isHost:!1,username:e,code:b.location.hash.split("/")[1],user_id:c.user_id,event_id:c.event_id}),g.isSent=!0,a.path("/"+b.localStorage.code+"/allDishes")})["catch"](function(b){Materialize.toast("Your entered room does not exist. <br>Redirecting...",2500),console.error("Error: Could not send session user info.",b),d(function(){a.path("/home")},2500)})}}angular.module("Piecemeal").controller("LoadingCtrl",a),a.$inject=["$location","$window","loadingFactory","$timeout","usersList","appFactory"]}(),function(){"use strict";function a(a){function b(b){return a({method:"POST",url:"/newUser",data:b}).then(function(a){return a.data})["catch"](function(a){throw a})}var c={sendSessionUser:b};return c}angular.module("Piecemeal").factory("loadingFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){var d=this;d.setSessionUser=function(d,e,f){a.createEvent({username:d}).then(function(a){_.assign(b.localStorage,{username:d,code:a.code,isHost:!0,user_id:a.user_id,event_id:a.event_id}),c.path("/"+a.code+"/allDishes")})["catch"](function(a){console.log("Error in creating event.")})}}angular.module("Piecemeal").controller("OAuthCtrl",a),a.$inject=["oAuthFactory","$window","$location"]}(),function(){"use strict";function a(a){function b(b){return a({method:"POST",url:"/createEvent",data:b}).then(function(a){return a.data})["catch"](function(a){console.error(a)})}var c={createEvent:b};return c}angular.module("Piecemeal").factory("oAuthFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){var d=this;a.copySessData(d),d.isVenmo=b.localStorage.venmoUsername;var e=b.location.hash,f=e.split("/");2===f.length&&"home"!==f[1]&&c.path(e.slice(2)+"/"),d.isLoggedIn=function(){return b.localStorage.getItem("code")},d.logout=a.logout}angular.module("Piecemeal").controller("NavbarCtrl",a),a.$inject=["appFactory","$window","$location"]}();